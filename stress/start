#!/usr/bin/env bash

##############################################################################
# Helper functions
##############################################################################

TEST_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
TMUX="tmux"
SESSION=TEST

source $TEST_DIR/lib/common-utils


function start_fe()
{
    $TMUX -f $TEST_DIR/lib/tmux.conf new-session -s "$SESSION" -n orchestrator -d
    $TMUX new-window -d -t "$SESSION" -n "fe"
    $TMUX send-keys -R -t "$SESSION:fe" "$TEST_DIR/lib/run-fe $CLARA_HOME $FE_HOST" "C-m"
}


function start_dpe()
{
    $TMUX new-window -d -t "$SESSION" -n "$1"
    $TMUX send-keys -R -t "$SESSION:$1" "ssh -t $1" "C-m"
    $TMUX send-keys -R -t "$SESSION:$1" "$TEST_DIR/lib/run-dpe $CLARA_HOME $FE_HOST" "C-m"
}

##############################################################################
# Check the plaftorm
##############################################################################

check_tmux
get_fe_host

##############################################################################
# Options
##############################################################################

function usage()
{
    echo -e "Usage:"
    echo -e "\t$0 [ -f <nodes_file> ] [ -s <first_node> ] <num_nodes>"
}


FIRST_NODE=1
KEEP_DETACHED=1
DRY_RUN=1
while getopts "hds:f:p:n" OPTION
do
    case $OPTION in
        h)
            usage; exit 0 ;;
        d)
            KEEP_DETACHED=0 ;;
        s)
            FIRST_NODE=$OPTARG ;;
        f)
            NODES_FILE=$OPTARG ;;
        n)
            DRY_RUN=0 ;;
        ?)
            echo; usage; exit 1 ;;
    esac
done

shift $((OPTIND-1))
if [[ ! $# -eq 1 ]]; then
    usage
    exit 1
fi

NUMBER_OF_NODES=$1
if [[ $NUMBER_OF_NODES -lt 0 ]]; then
    echo "Wrong number of nodes: $NUMBER_OF_NODES"
    exit 1
fi

case $(hostname -s) in
    "head")
        NODES_FILE=$TEST_DIR/nodes/quark.list
        ;;
    "hadlab")
        NODES_FILE=$TEST_DIR/nodes/csu.list
        ;;
    "claradm")
        echo "Running on claradm. Only the front-end node can be used."
        NODES_FILE=
        NUMBER_OF_NODES=0
        ;;
esac

if [[ $NUMBER_OF_NODES -gt 0 ]]; then
    if [[ -z $NODES_FILE ]]; then
        echo "A file with the list of available nodes is required."
        echo "See nodes/quark.list as an example."
        echo
        usage
        exit 1
    fi
    echo "NODES_FILE=$NODES_FILE"
else
    echo "Running everything on front-end node. No extra DPEs will be deployed."
fi
echo "---"


##############################################################################
# Start the FE and the DPEs
##############################################################################

# Remove any existing tmux session first
$TEST_DIR/quit

cd $TEST_DIR
rm -rf $TEST_DIR/log
mkdir -p $TEST_DIR/log

echo "Starting front-end on local node $FE_HOST"
if [[ $DRY_RUN -eq 1 ]]; then
    start_fe
    sleep 2
fi

cat << EOF > $TEST_DIR/log/nodes.yaml
---
input-output:
  - name: $FE_HOST
reconstruction:
EOF

if [[ $NUMBER_OF_NODES -eq 0 ]]; then
    echo "  - name: $FE_HOST" >> $TEST_DIR/log/nodes.yaml
else
    counter=0
    last=$(($FIRST_NODE+$NUMBER_OF_NODES-1))
    while read NODE
    do
        let counter=counter+1
        if [[ $counter -ge $FIRST_NODE ]]; then
            echo "Starting DPE on $NODE"
            echo "  - name: $NODE" >> $TEST_DIR/log/nodes.yaml
            if [[ $DRY_RUN -eq 1 ]]; then
                start_dpe $NODE
            fi
        fi
        if [[ $counter -eq $last ]]; then
            break
        fi
    done < $NODES_FILE
fi

if [[ $DRY_RUN -eq 0 ]]; then
    exit 0
fi

sleep 1
if [[ $KEEP_DETACHED -eq 1 ]]; then
    $TMUX select-window -t "$SESSION:orchestrator"
    $TMUX -2 attach-session -t "$SESSION"
fi
