#!/bin/bash

##############################################################################
# Helper functions
##############################################################################

TEST_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
SESSION=TEST

source $TEST_DIR/lib/common-utils


function start_platform()
{
    cat /dev/null > $TEST_DIR/nodes
    screen -d -m -S $SESSION -c $TEST_DIR/lib/screenrc
    echo "Starting platform..."
    screen -S $SESSION -X screen -t platform $TEST_DIR/lib/run-platform $CLARA_SERVICES
    sleep 2
}


function start_dpe()
{
    screen -S $SESSION -X screen -t $1 ssh -t $1 $TEST_DIR/lib/run-dpe $PLATFORM_HOST $CLARA_SERVICES
    sleep 0.25
}

##############################################################################
# Check the plaftorm
##############################################################################

get_platform_host

##############################################################################
# Options
##############################################################################

function usage()
{
    echo -e "Usage:"
    echo -e "\t$0 [-s <first_node> ] <nodes>"
}


FIRST_NODE=1
KEEP_DETACHED=1
while getopts “hdfs:” OPTION
do
    case $OPTION in
        h)
            usage; exit 0 ;;
        d)
            KEEP_DETACHED=0 ;;
        s)
            FIRST_NODE=$OPTARG ;;
        ?)
            echo; usage; exit 1 ;;
    esac
done

shift $((OPTIND-1))
if [[ ! $# -eq 1 ]]; then
    usage
    exit 1
fi

##############################################################################
# Check the nodes
##############################################################################

NUMBER_OF_NODES=$1
if [[ $PLATFORM_HOST == "head" ]]; then
    MAX_NODES=12
    if [[ $FIRST_NODE -lt 1 || $FIRST_NODE -gt $MAX_NODES ]]; then
        echo "Wrong node number: $FIRST_NODE"
        exit 1;
    fi
else
    MAX_NODES=0
fi
if [[ $NUMBER_OF_NODES -lt 0 || $NUMBER_OF_NODES -gt $MAX_NODES ]]; then
    echo "Wrong node number: $NUMBER_OF_NODES"
    exit 1;
fi

##############################################################################
# Start the platform and the DPEs
##############################################################################

# Remove any existing screen session first
$TEST_DIR/quit

cd $TEST_DIR
rm -rf $TEST_DIR/log
mkdir -p $TEST_DIR/log

start_platform

cat << EOF > $TEST_DIR/log/nodes.yaml
---
input-output:
  - name: $PLATFORM_HOST
reconstruction:
EOF

if [[ $NUMBER_OF_NODES -eq 0 ]]; then
    echo "  - name: $PLATFORM_HOST" >> $TEST_DIR/log/nodes.yaml
else
    counter=$FIRST_NODE
    last=$(($FIRST_NODE+$NUMBER_OF_NODES))
    while [[ $counter -lt $last ]]; do
        case $counter in
            [1-9])    node="physics0$counter"   ;;
            1[0-6])   node="physics$counter"    ;;
        esac
        echo "Starting DPE on $node..."
        echo "  - name: $node" >> $TEST_DIR/log/nodes.yaml
        start_dpe $node
        let counter=counter+1
    done
fi

sleep 1
if [[ $KEEP_DETACHED -eq 1 ]]; then
    screen -r -S $SESSION -p 0
fi
