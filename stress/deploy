#!/bin/bash

TEST_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

##############################################################################
# Check the list of nodes
##############################################################################

NODES_FILE=$TEST_DIR/log/nodes.yaml

if [[ ! -f $NODES_FILE ]]; then
    echo "Run start first. Could not find file with description of nodes."
    exit 1
fi

##############################################################################
# Options
##############################################################################

function usage()
{
    echo "Usage:"
    echo -e "\t$0 <services_file>"
}


while getopts "h" OPTION
do
    case $OPTION in
        h)
            usage; exit 0 ;;
        ?)
            usage; exit 1 ;;
    esac
done

shift $((OPTIND-1))
if [[ ! $# -eq 1 ]]; then
    usage
    exit 1
fi

##############################################################################
# Deploy and link all I/O and reconstruction services
##############################################################################

${CLARA_SERVICES}/bin/default-orchestrator setup-chain -n $NODES_FILE "$1" 2>&1 |
    tee $TEST_DIR/log/deploy.log
