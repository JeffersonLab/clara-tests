#!/usr/bin/env python3

import argparse
import re
import yaml

tokens = []
times = {}


def nonblank_lines(f):
    r = '^\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}.\d{3}: '
    for line in f.readlines():
        line = re.sub(r, '', line.strip())
        if line:
            yield line


def parse_services(services_file):
    rec_chain = []
    with open(services_file) as f:
        data = yaml.safe_load(f)
        for service in data['services']:
            rec_chain.append(service['name'])

    global tokens
    tokens = ['READER'] + rec_chain + ['WRITER', 'TOTAL']
    for token in tokens:
        times[token] = []


def parse_time(log_file):
    with open(log_file) as f:
        for line in nonblank_lines(f):
            line = line.split()
            token = line[0]
            if token in times:
                time = line[-2]
                times[token].append(time)


def print_results():
    N = 3
    T = int(len(times['TOTAL']) / N)
    print('Cores;' + ';'.join(tokens))
    for n in range(T):
        line = '%d' % (n + 1)
        i = n * N
        for token in tokens:
            token_times = [float(v) for v in times[token][i:i+N]]
            token_avg = sum(token_times) / N
            line += ';%.2f' % token_avg
        print(line)


if __name__ == '__main__':

    argparser = argparse.ArgumentParser()
    argparser.add_argument('services_yaml', help='the services.yaml file')
    argparser.add_argument('log_file', help='the multicore-test output')
    args = argparser.parse_args()

    parse_services(args.services_yaml)
    parse_time(args.log_file)
    print_results()
